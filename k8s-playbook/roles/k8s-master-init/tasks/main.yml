---
- name: Check if cluster is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_admin_conf

- name: Pull kube-vip image
  shell: |
    crictl --debug pull artifactory-virtual.caas.in.pan-net.eu/kube-vip/kube-vip:{{ kube_vip_version }}
    ctr images pull artifactory-virtual.caas.in.pan-net.eu/kube-vip/kube-vip:{{ kube_vip_version }}

- name: Create kubernetes manifests directory
  file:
    path: /etc/kubernetes/manifests
    state: directory
    mode: '0755'

- name: Generate kube-vip manifest
  shell: |
    ctr --namespace k8s.io run --rm --net-host \
      artifactory-virtual.caas.in.pan-net.eu/kube-vip/kube-vip:{{ kube_vip_version }} vip \
      /kube-vip manifest pod \
        --arp \
        --interface {{ dth_interface }} \
        --vip {{ k8s_api_ip }} \
        --controlplane \
        --leaderElection > /etc/kubernetes/manifests/kube-vip.yaml

- name: Fix kube-vip admin.conf path after init
  replace:
    path: /etc/kubernetes/manifests/kube-vip.yaml
    regexp: 'path: /etc/kubernetes/admin.conf'
    replace: 'path: /etc/kubernetes/super-admin.conf'
  when: not k8s_admin_conf.stat.exists

- name: Fix kube-vip image registry
  replace:
    path: /etc/kubernetes/manifests/kube-vip.yaml
    regexp: 'ghcr.io'
    replace: 'artifactory-virtual.caas.in.pan-net.eu'

- name: Create kubeadm config
  template:
    src: kubeadm-config.yaml.j2
    dest: /root/kubeadm-config.yaml
  when: not k8s_admin_conf.stat.exists

- name: Initialize Kubernetes cluster
  shell: kubeadm init --config /root/kubeadm-config.yaml --skip-phases addon/coredns,addon/kube-proxy --upload-certs
  register: kubeadm_init_result
  when: not k8s_admin_conf.stat.exists

- name: Wait for API server to be ready after init
  wait_for:
    port: 6443
    host: "127.0.0.1"
    timeout: 120
  when: not k8s_admin_conf.stat.exists and kubeadm_init_result is defined

- name: Fix kube-vip admin.conf path after init
  replace:
    path: /etc/kubernetes/manifests/kube-vip.yaml
    regexp: 'path: /etc/kubernetes/super-admin.conf'
    replace: 'path: /etc/kubernetes/admin.conf'
  when: not k8s_admin_conf.stat.exists

- name: Generate bootstrap token
  shell: kubeadm token create
  register: bootstrap_token
  # when: k8s_admin_conf.stat.exists or kubeadm_init_result is defined

- name: Get discovery token hash
  shell: |
    openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
    openssl dgst -sha256 -hex | sed 's/^.* /sha256:/'
  register: discovery_token_hash
  # when: k8s_admin_conf.stat.exists or kubeadm_init_result is defined

- name: Generate certificate key for joining masters
  shell: kubeadm certs certificate-key
  register: certificate_key
  # when: k8s_admin_conf.stat.exists or kubeadm_init_result is defined

- name: Upload certificates with generated key
  shell: kubeadm init phase upload-certs --certificate-key {{ certificate_key.stdout }}
  # when: k8s_admin_conf.stat.exists or kubeadm_init_result is defined

- name: Enable kube-vip leader election after init
  replace:
    path: /etc/kubernetes/manifests/kube-vip.yaml
    regexp: 'name: vip_leaderelection\n\s+value: "false"'
    replace: 'name: vip_leaderelection\n      value: "true"'
  when: not k8s_admin_conf.stat.exists and kubeadm_init_result is defined

- name: Set join tokens as facts
  set_fact:
    kubeadm_token: "{{ bootstrap_token.stdout }}"
    kubeadm_discovery_token: "{{ discovery_token_hash.stdout }}"
    kubeadm_cert_key: "{{ certificate_key.stdout }}"
  # when: k8s_admin_conf.stat.exists or kubeadm_init_result is defined

- name: Display kubeadm init output
  debug:
    var: kubeadm_init_result.stdout_lines
  when: 
    - not k8s_admin_conf.stat.exists
    - kubeadm_init_result is defined

- name: Display generated tokens
  debug:
    msg:
      - "Bootstrap token: {{ kubeadm_token }}"
      - "Discovery token: {{ kubeadm_discovery_token }}"
      - "Certificate key: {{ kubeadm_cert_key }}"
      - "IMPORTANT: CoreDNS and kube-proxy phases were skipped"
      - "You'll need to install these components separately"
  # when: k8s_admin_conf.stat.exists or kubeadm_init_result is defined